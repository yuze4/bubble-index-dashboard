<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Tech/AI Bubble Index</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #050915;
      --card: rgba(15, 23, 42, 0.78);
      --border: rgba(255, 255, 255, 0.06);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warn: #eab308;
      --coin: #e8c547;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(34, 197, 94, 0.08), transparent 30%),
        radial-gradient(circle at 82% 18%, rgba(34, 211, 238, 0.12), transparent 30%),
        linear-gradient(135deg, rgba(232, 197, 71, 0.05), rgba(34, 211, 238, 0.08)),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 34px;
      overflow-x: hidden;
      position: relative;
    }

    /* currency-inspired rings */
    body::before, body::after {
      content: "";
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(232,197,71,0.16), transparent 55%);
      filter: blur(70px);
      z-index: 0;
    }
    body::before { width: 360px; height: 360px; top: -120px; left: -120px; opacity: 0.7; }
    body::after { width: 520px; height: 520px; bottom: -220px; right: -160px; background: radial-gradient(circle, rgba(34,211,238,0.15), transparent 55%); }

    .shell {
      position: relative;
      z-index: 1;
      max-width: 1220px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .coin {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #f5ecb3 35%, #1e293b 70%);
      border: 2px solid rgba(255,255,255,0.18);
      box-shadow: 0 12px 50px rgba(0,0,0,0.35);
      display: grid;
      place-items: center;
      color: #0f172a;
      font-weight: 800;
      font-size: 18px;
    }

    h1 { margin: 0; font-size: 28px; }
    .muted { color: var(--muted); }

    .cta {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(34,211,238,0.14);
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
    }

    .grid { display: grid; gap: 16px; margin-top: 18px; }
    .cards { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 16px 60px rgba(0,0,0,0.28);
      backdrop-filter: blur(10px);
    }

    .card h3 { margin: 0 0 6px; color: var(--muted); font-size: 13px; letter-spacing: 0.2px; }
    .value { font-size: 34px; font-weight: 700; }
    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .chip.ok { background: rgba(34,197,94,0.14); color: #22c55e; }
    .chip.warn { background: rgba(234,179,8,0.14); color: #eab308; }
    .chip.danger { background: rgba(239,68,68,0.14); color: #ef4444; }

    .section-title { display: flex; align-items: center; justify-content: space-between; margin: 24px 0 10px; flex-wrap: wrap; gap: 10px; }
    .section-title h2 { margin: 0; font-size: 18px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 11px 10px; border-bottom: 1px solid var(--border); font-size: 14px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .chart-card { padding: 12px; }
    canvas { width: 100%; }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(239,68,68,0.12);
      color: #fecdd3;
      border: 1px solid rgba(239,68,68,0.32);
      margin-top: 12px;
    }

    .placeholder-flag { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; background: rgba(234,179,8,0.14); color: #eab308; font-weight: 700; }

    .currency-band {
      position: relative;
      padding: 18px;
      border-radius: 14px;
      background: linear-gradient(120deg, rgba(232,197,71,0.12), rgba(34,211,238,0.08));
      border: 1px dashed rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .currency-band::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: linear-gradient(90deg, rgba(255,255,255,0.06) 1px, transparent 1px);
      background-size: 12px 12px;
      opacity: 0.18;
      pointer-events: none;
    }

    .loading { color: var(--muted); display: flex; align-items: center; gap: 10px; }
    .loading span { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.4); opacity: 1; } }

    @media (max-width: 760px) { body { padding: 22px; } header { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="shell" id="app">
    <header>
      <div class="title">
        <div class="coin">$</div>
        <div>
          <h1>US Tech/AI Bubble Index</h1>
          <div class="muted">Currency-inspired dashboard of market froth</div>
        </div>
      </div>
      <div class="currency-band">
        <div class="muted" style="font-size: 13px;">Bubble index blends options sentiment, tech price stretch, macro risk and IPO heat into one currency-themed view.</div>
      </div>
    </header>

    <div style="margin-top: 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
      <div v-if="placeholderUsed" class="placeholder-flag">Placeholder datapoints detected</div>
      <div class="muted">{{ timestampText }}</div>
    </div>

    <div class="grid cards">
      <div class="card" v-for="card in headlineCards" :key="card.label">
        <h3>{{ card.label }}</h3>
        <div class="value">{{ card.value }}</div>
        <div class="muted">{{ card.subtext }}</div>
      </div>
    </div>

    <div class="section-title">
      <h2>Bubble pulse</h2>
      <span class="chip" :class="tone.class">{{ tone.text }}</span>
    </div>
    <div class="card chart-card">
      <canvas id="history-chart"></canvas>
      <div v-if="!history.length" class="alert">No historical records yet. Run <code>python bubble_calc.py</code> to populate <code>data/bubble_daily.csv</code>.</div>
    </div>

    <div class="section-title">
      <h2>Raw inputs from <code>bubble_today.json</code></h2>
      <div class="muted">Intraday gauges with risk-coloured badges</div>
    </div>
    <div class="card">
      <div v-if="loading" class="loading"><span></span> Loading latest metrics…</div>
      <table v-else>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="metric in metrics" :key="metric.label">
            <td>{{ metric.label }}</td>
            <td>{{ metric.value }}</td>
            <td v-html="metric.badge"></td>
          </tr>
        </tbody>
      </table>
      <div v-if="error" class="alert">{{ error }}</div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
      setup() {
        const latest = ref(null);
        const history = ref([]);
        const loading = ref(true);
        const error = ref('');
        const chartRef = ref(null);
        let chartInstance = null;
        const formatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });

        const placeholderUsed = computed(() => {
          if (!latest.value || !latest.value.raw) return false;
          return Object.values(latest.value.raw).some(v => Number(v) === 0);
        });

        const timestampText = computed(() => {
          if (!latest.value || !latest.value.timestamp) return 'Awaiting snapshot…';
          return `Last updated ${new Date(latest.value.timestamp).toLocaleString()}`;
        });

        const headlineCards = computed(() => {
          const data = latest.value;
          return [
            {
              label: 'Bubble Index (0-10)',
              value: data ? formatter.format(data.bubbleIndex ?? 0) : '--',
              subtext: 'Composite view of froth & sentiment',
            },
            {
              label: 'Weighted Score',
              value: data ? formatter.format(data.weightedScore ?? 0) : '--',
              subtext: '0 = calm, 5+ = overheated',
            },
            {
              label: 'Total Put/Call',
              value: data ? formatter.format(data?.raw?.totalPutCall ?? 0) : '--',
              subtext: `Equity ${formatter.format(data?.raw?.equityPutCall ?? 0)} | Index ${formatter.format(data?.raw?.indexPutCall ?? 0)}`,
            },
            {
              label: 'QQQ vs 200d MA',
              value: data ? `${formatter.format((data?.raw?.priceDeviation ?? 0) * 100)}%` : '--',
              subtext: 'Deviation from long-term trend',
            },
          ];
        });

        const metrics = computed(() => {
          if (!latest.value) return [];
          const raw = latest.value.raw || {};
          const scores = latest.value.scores || {};
          return [
            { label: 'QQQ deviation vs 200d MA', value: `${formatter.format((raw.priceDeviation ?? 0) * 100)}%`, badge: badge(scores.priceDeviation) },
            { label: 'Total put/call ratio', value: formatter.format(raw.totalPutCall ?? 0), badge: badge(scores.totalPutCall) },
            { label: 'Equity vs Index put/call spread', value: `${formatter.format(raw.equityPutCall ?? 0)} / ${formatter.format(raw.indexPutCall ?? 0)}`, badge: badge(scores.smartDumb) },
            { label: 'VIX level', value: formatter.format(raw.vix ?? 0), badge: badge(scores.vix) },
            { label: 'ANFCI', value: formatter.format(raw.anfci ?? 0), badge: badge(scores.anfci) },
            { label: 'IPO count (30d)', value: formatter.format(raw.ipoCount30d ?? 0), badge: badge(scores.ipoHeat) },
          ];
        });

        const tone = computed(() => {
          const value = latest.value?.bubbleIndex ?? 0;
          if (value >= 8) return { text: 'Speculative fever', class: 'danger chip' };
          if (value >= 5) return { text: 'Elevated risk-on', class: 'warn chip' };
          return { text: 'Measured optimism', class: 'ok chip' };
        });

        function badge(score) {
          if (score >= 2) return '<span class="chip danger">Frothy</span>';
          if (score === 1) return '<span class="chip warn">Elevated</span>';
          return '<span class="chip ok">Calm</span>';
        }

        async function fetchJson(url) {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load ' + url);
          return res.json();
        }

        async function fetchCsv(url) {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load ' + url);
          const text = (await res.text()).trim();
          if (!text) return [];
          const [header, ...rows] = text.split(/\r?\n/);
          const headers = header.split(',');
          return rows.map(line => {
            const values = line.split(',');
            const item = {};
            headers.forEach((key, idx) => item[key] = values[idx]);
            item.bubbleIndex = Number(item.bubbleIndex);
            return item;
          });
        }

        async function loadLatest() {
          loading.value = true;
          try {
            latest.value = await fetchJson('./bubble_today.json');
          } catch (err) {
            console.error(err);
            error.value = 'Unable to load latest snapshot';
          } finally {
            loading.value = false;
          }
        }

        async function loadHistory() {
          try {
            history.value = await fetchCsv('./data/bubble_daily.csv');
          } catch (err) {
            console.warn('No history available:', err);
            history.value = [];
          }
        }

        function buildChart() {
          const el = document.getElementById('history-chart');
          if (!el) return;
          if (chartInstance) chartInstance.destroy();
          if (!history.value.length) return;
          const labels = history.value.map(row => new Date(row.timestamp).toLocaleDateString());
          const values = history.value.map(row => row.bubbleIndex);
          chartInstance = new Chart(el, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Bubble Index',
                data: values,
                borderColor: '#22d3ee',
                backgroundColor: 'rgba(34,211,238,0.16)',
                tension: 0.35,
                fill: true,
                pointRadius: 3,
              }],
            },
            options: {
              plugins: { legend: { display: false } },
              scales: {
                x: { grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, suggestedMin: 0, suggestedMax: 10 },
              },
            },
          });
        }

        watch(history, () => buildChart());
        onMounted(() => {
          loadLatest();
          loadHistory();
        });

        return { headlineCards, metrics, tone, placeholderUsed, timestampText, loading, error, history };
      }
    }).mount('#app');
  </script>
</body>
</html>
